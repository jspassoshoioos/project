---
title: "PA 434 Final Project"
author: "Mia Krout & Jake da Silva Passos-Hoioos"
date: "4/25/2021"
output: pdf_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, include = F)
```

# Motivation and Research Questions

## Needed Packages

```{r libraries for apis}
#install.packages(c("httr", "jsonlite", "RSocrata"))
library(httr)
library(jsonlite)
library(RSocrata)
library(tidyverse)
library(kableExtra)
library(ggpubr)
library(censusapi)

#API key ID: 7vwfj55tah2za8t0hmgcwkc2w
#API key secret: 4vxjm7n1v7ddid1vhlx4hvn3v0k9dnagm8hc76xm8m7rsbt7jo
```

## Background

It is a well known fact that the City of Chicago is a city of neighborhoods. In total
Chicago has over 77 Community Areas, that roughly correspond (although they do not fully encapsulate) 
the many neighborhoods and communities within the city. It is also a well known fact that Chicago is a segregated city. Decades of practices such as
redlining, restrictive housing covenants, as well as outright legalized housing discrimination
has left the city with stark racial and ethnic boundaries that remain clear even
now. [Racial dot maps](http://www.radicalcartography.net/index.html?chicagodots) 
of the city are particularly revealing of the city's continued racial and ethnic 
homogeneity across the city, most predominately among Black Chicagoans on the South
and West Sides. Political boundaries, most notably,
[Congressional districts](https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/United_States_Congressional_Districts_in_Illinois_%28metro_highli,ght%29%2C_2003_%E2%80%93_2013.tif/lossless-page1-400px-United_States_Congressional_Districts_in_Illinois_%28metro_highlight%29%2C_2003_%E2%80%93_2013.tif.png) take particularly unusual form in an effort to follow these tight boundaries. 

Acknowledging the extent of the city's segregated state is critical, as even the 
wishful or naive supposition that the city isn't segregated can have profound
consequences on the communities that have been historically marginalized and denied
equal opportunities and access. While the original motivation for this research was 
to study if there *was* a bias in the areas that the Chicago Transit Authority (CTA) 
was making improvements to (e.g., improvements being made solely or predominately in White, wealthy, 
well educated neighborhoods). In further research of this topic, the answer to 
this question became clear: there is indeed bias within the areas the CTA improves, but
these are inherent biases that are the result of the decades of institutional racism and 
bias towards communities of color. 

Consider the shape of the CTA system, sprawling with many lines radiating outward
from the central downtown Loop. Lines radiate out in every direction 
but East due to Lake Michigan, but despite this, of the 10 different lines or branches
leaving the Loop, almost half of them (4) head North, while the remaining 6 lines or branches
are equally divided heading South (3) and West (3). Looking back at a demographic 
map of the city this comes as no surprise, Chicago's densest, and Whitest areas 
are situated to the North of the Loop, and are cut through by the Red, Brown, Purple, and in 
more recent years, Blue (along the Milwaukee Avenue Branch) lines. Meanwhile, on the South 
and West sides, the lines take on much different shapes, with two lines, the Red (Dan-Ryan Branch) and  Blue line (Forest Park Branch), 
being constructed in the medians of the interstate highways that were constructed during the post-war housing
boom. As many White households moved out of city areas in favor of suburban living, a phenomenon often refer to
as "White flight," the investment and focus on creating reliable transportation infrastructure followed them to the suburbs. 

Thus it became clear that if our research was seeking to determine if there is in fact
a bias in the areas served by and thusly the recipient of transportation improvement projects, that
the answer would be a **resounding yes.** While there is certainly still disagreement within the
subject as to *why* these inequities and biases exist and persist, the fact remains that these inequities and 
biases **do** exist. Rather than seek to add to the existing explanations for these inequities, this research
seeks to observe them, to try and quantify it so as to better understand them so that they 
can be more readily addressed and the historical wrongs to minority communities can be righted. 

## Research Questions 

With the focus now turned towards observing the known inequities that exist within
the CTA, the scope of this research comes more easily into view. If it is accepted
that the CTA has inherent bias in its design and the communities it sought to serve,  
that is to serve White communities on the North side at the expense of service to
communities of color on the West and South sides, then it is no surprise that 
improvements made to the very same system will reflect a bias towards a specific 
demographic. Because Chicago continues to be such a highly segregated city, the 
greater frequency of improvement projects in these specific communities, where the most
heavily trafficked parts of the system are located, becomes understandable. 

The new question that emerges is: 

* If we accept that the system is inherently bias against minority communities, what 
effect would we expect these projects to have on ridership within these communities? 
 + In a system that was made to serve primarily White, middle to upper class, and highly educated areas, 
 we would expect improvements to cluster in these communities and are likely to result in a greater
 benefit (reflected through greater gains in ridership) than similar improvements made
 within communities that have been historically underserved by the CTA.  
 + If the improvements in these underserved communities are viewed within a "performative" 
 framework (i.e., improvements are made to these communities as a form of lip service, 
 to create the appearance of equity, while not actually improving ridership), then we
 would expect improvements in these communities to have a less notable impact on 
 ridership.
 
In order to address this question there are two key sets of data we need to analyze: 

* Demographics of neighborhoods where CTA system improvements have been made.
* Ridership statistics for these areas (stations) before and after the improvements were made. 

To study the demographic data of the areas subject to CTA improvements, we  
utilize data made available by the [American Community Survey (ACS)](https://www.census.gov/programs-surveys/acs/about.html), a demography 
study program conducted by the U.S. Census Bureau. Conveniently, Chicago's 77 community 
areas correspond to the census tract group areas used by the Census, such that tract
level census data can be easily aggregated to the neighborhood level due to the tract boundaries
aligning with the community area boundaries. 

**An important note** regarding ACS estimate values: The ACS estimates utilized for 
the purposes of this research are the **5-year estimates.** This means that the estimated
values used in this project are the ACS estimates for a given census tract for the 5 year-period spanning
from 2005 to 2010. This decision was driven  Although these estimates will be frequently referred to as the **2010 estimates**
or **2010 5 year estimates** the estimate values are reflective of the estimated value for the entire 5 year period 
(i.e., 2005 to 2010) not simply the 2010 calendar year.

Another **important note** regarding the Census tracts used for this analysis. Census data
is grouped using the former Federal Information Processing Standards (FIPS) codes, which
uniquely identifies each county or county equivalent within the United States, as
well as certain possessions and freely associated states. Accordingly, the smallest 
political unit captured by the U.S. Census is the **county** rather than the individual
**municipalities** (such as the City of Chicago) that make up counties. 

A consequence of this is that it is *extremely difficult* to identify the specific 
census tracts that are contained within a given municipality, as the only centralized
listings of census tracts are provided at the *county* level, and even then the only 
instance that we could find a full listing of census tracts in Cook County from a 
U.S. government department or agency, was from the [Department of Justice (DOJ)](https://www.justice.gov/crt/designated-census-tracts-chicago-il-pmsa-county). 
For the purposes of this analysis, the specific census tracts in the city of Chicago 
were determined from [this map](https://www.csu.edu/cerc/documents/ChicagoCommunityAreasMapWithCensusTracts2000-NIPC.pdf)
published by the Northeastern Illinois Planning Commission. 

What quickly became apparent was there was some data missing. The 2010 census found 
a total population for the city of Chicago to be approximately 2.6 million, while 
our the aggregate of our census data indicates a population estimate of approximatley 2.4 
million. 

To identify the specific improvement projects of interest, the [CTAs list](https://www.transitchicago.com/newsprojects/system-improvement-projects/completed-station-projects) of past projects
was reviewed. From this list a deliberate sample was selected with the intent to ensure 
that the group of improvements was a heterogeneous group with demographics comparable to the 
city at large. The goal of this is to then compare the differences in ridership from before and after the improvement
was made to see if there were any meaningful differences across the different groups, for example, if projects in predominantly White neighborhoods have a greater impact on ridership than those made in predominately minority neighborhoods. 

To see if there were any meaninful changes in the ridership before and after the improvement was made, the CTA's publicly available [daily ridership dataset](https://data.cityofchicago.org/Transportation/CTA-Ridership-L-Station-Entries-Daily-Totals/5neh-572f) that provides the daily number of station entries for each station from 2001 to present. 

# Data Prep and Cleaning - Census Data

**Please Note**: The Census Bureau requires users to obtain their own
personal API key. The code chunk titled "API Key" contains an empty
string for you to insert your own API key. This chunk has been excluded
from the text of this report for brevity.

```{r Census API}
# Only run the below the first time you are setting up the API key
#
# Insert your actual API Key before running if not Mia or Jake
Sys.setenv(CENSUS_KEY = "072a5932353383e73bef59d5792a0c5c93940755")
#
readRenviron("~/.Renviron")
Sys.getenv("CENSUS_KEY")

```

The package censusapi contains metadata about each of the available APIs
and the data accessible from said APIs, and can be quite useful when
trying to identify the relevant data set.

```{r Looking at Data}
apis <- listCensusApis()

view(apis)

project_vars <- listCensusMetadata(
  name = "acs/acs5", 
  vintage = 2019,
  type = "variables",
)

project_geo <- listCensusMetadata(name = "dec/sf1", vintage = 2010, type = "geography")

head(project_geo)
```

```{r  Calling Data}

demo_2010 <- as_tibble(
  getCensus(name = "acs/acs5", # name specifies the census data, in this case the ACS 5 year ests.  
            vintage = 2010, # For non-time series data vintage = year 
            vars = c("NAME", # Provides name of jurisdiction (here tracts)
                     "B03002_001E", ### Total Race/Ethnicity 
                     "B03002_002E", # Total Non-Hispanic
                     "B03002_003E", # Non-Hispanic White
                     "B03002_004E", # Non-Hispanic Black
                     "B03002_005E", # Non-Hispanic Native American
                     "B03002_006E", # Non-Hispanic Asian
                     "B03002_007E", # Non-Hispanic Hawaiian or Pacific Islander
                     "B03002_008E", # Non-Hispanic Other
                     "B03002_009E", # Non-Hispanic Two or more races (Multiracial)
                     "B03002_012E", # Total Hispanic
                     "B03002_013E", # Hispanic White
                     "B03002_014E", # Hispanic Black
                     "B03002_015E", # Hispanic Native American
                     "B03002_016E", # Hispanic Asian
                     "B03002_017E", # Hispanic Hawaiian or Pacific Islander
                     "B03002_018E", # Hispanic Other 
                     "B03002_019E", # Hispanic Two or more races (Multiracial)
                     "B15002_001E", # Total Educ
                     "B15002_002E", # Total Educ - Males
                     "B15002_003E", # Males Less than HS 
                     "B15002_004E", # Males Less than HS 
                     "B15002_005E", # Males Less than HS 
                     "B15002_006E", # Males Less than HS 
                     "B15002_007E", # Males Less than HS 
                     "B15002_008E", # Males Less than HS 
                     "B15002_009E", # Males Less than HS 
                     "B15002_010E", # Males Less than HS
                     "B15002_011E", # Males HS or some college 
                     "B15002_012E", # Males HS or some college
                     "B15002_013E", # Males HS or some college
                     "B15002_014E", # Males College degree +  
                     "B15002_015E", # Males College degree + 
                     "B15002_016E", # Males College degree +
                     "B15002_017E", # Males College degree + 
                     "B15002_018E", # Males College degree + 
                     "B15002_019E", # Total Educ - Females
                     "B15002_020E", # Females Less than HS 
                     "B15002_021E", # Females Less than HS 
                     "B15002_022E", # Females Less than HS 
                     "B15002_023E", # Females Less than HS 
                     "B15002_024E", # Females Less than HS 
                     "B15002_025E", # Females Less than HS 
                     "B15002_026E", # Females Less than HS 
                     "B15002_027E", # Females Less than HS 
                     "B15002_028E", # Females HS or some college
                     "B15002_029E", # Females HS or some college
                     "B15002_030E", # Females HS or some college
                     "B15002_031E", # Females College degree + 
                     "B15002_032E", # Females College degree +
                     "B15002_033E", # Females College degree +
                     "B15002_034E", # Females College degree +
                     "B15002_035E", # Females College degree +
                     "B16001_001E", ### Total Language Spoken at Home
                     "B16001_002E", # English only
                     "B16001_003E", # Spanish Total
                     "B16001_004E", # Spanish, English Very Well 
                     "B16001_005E", # Spanish, English Less Than Very Well  
                     "B16001_036E", # Polish Total
                     "B16001_037E", # Polish, English Very Well  
                     "B16001_038E", # Polish, English Less Than Very Well  
                     "B16001_066E", # Chinese Total 
                     "B16001_067E", # Chinese, English Very Well 
                     "B16001_068E", # Chinese, English Less Than Very Well 
                     "B16001_093E", # Tagalog (incl. Filipino) Total
                     "B16001_094E", # Tagalog, English Very Well
                     "B16001_095E", # Tagalog, English Less Than Very Well
                     "B16001_108E", # Arabic Total
                     "B16001_109E", # Arabic, English Very Well
                     "B16001_110E", # Arabic, English Less Than Very Well
                     "B19013_001E"), # Median Income
            region = "tract:*", # Indicates we want tract level data 
            regionin =  "state:17+county:031")  # ID State and County using FIPS
)

```

Public census data is available at various jurisdiction levels, from
multi-state regions down to individual block groups. For our project,
our interest was on Chicago community areas, which approximate Chicago's
various neighborhoods. Each of these areas are comprised of many
individual census tracts. As previously noted, for our analysis, we used a map 
published by the Northeastern Illinois Planning Commission, with each community 
area and the census tracts that comprise that community. After identifying each of the
community areas for each improvement project, we then used the
identified census tracts to calculate the approximate populations of
each community.

Given the lack of clarity regarding the census tracts contained within Chicago, 
as well as the unusual tracts found along the city's edges, we suspect that 
the approximately 200,000 individuals that are seemingly missing from our data are
residents of these unusual tract areas. 

```{r Cleaning Data}

chicago_2010 <- demo_2010 %>% 
  rename(re_total = B03002_001E,
         nh_total = B03002_002E,
         nh_white = B03002_003E, 
         nh_black = B03002_004E,
         nh_native = B03002_005E, 
         nh_asian = B03002_006E, 
         nh_pi = B03002_007E, 
         nh_other = B03002_008E,
         nh_multi = B03002_009E,
         h_total = B03002_012E, 
         h_white = B03002_013E, 
         h_black = B03002_014E, 
         h_native = B03002_015E, 
         h_asian = B03002_016E, 
         h_pi = B03002_017E, 
         h_other = B03002_018E,
         h_multi = B03002_019E, 
         lang_total = B16001_001E, 
         eng = B16001_002E, 
         sp_total = B16001_003E,
         sp_gd_eng = B16001_004E, 
         sp_bd_eng = B16001_005E, 
         plsk_total = B16001_036E,
         plsk_gd_eng = B16001_037E,
         plsk_bd_eng = B16001_038E, 
         chn_total = B16001_066E, 
         chn_gd_eng = B16001_067E, 
         chn_bd_eng = B16001_068E, 
         flp_total = B16001_093E,
         flp_gd_eng = B16001_094E, 
         flp_bd_eng = B16001_095E, 
         arab_total = B16001_108E, 
         arab_gd_eng = B16001_109E, 
         arab_bd_eng = B16001_110E, 
         edu_total = B15002_001E, 
         median_income = B19013_001E) %>%
  mutate(native_gd_eng = eng + sp_gd_eng + plsk_gd_eng + chn_gd_eng + flp_gd_eng + arab_gd_eng,
         not_eng = sp_total + plsk_total + chn_total + flp_total + arab_total, 
         bd_eng = sp_bd_eng + plsk_bd_eng + chn_bd_eng + flp_bd_eng + arab_bd_eng, 
         no_hs = B15002_003E + B15002_004E + B15002_005E + B15002_006E + B15002_007E +
         B15002_008E + B15002_009E + B15002_010E + B15002_020E + B15002_021E + B15002_022E + 
         B15002_023E + B15002_024E + B15002_025E + B15002_026E + B15002_027E,
         hs = B15002_011E + B15002_012E + B15002_013E + B15002_028E + B15002_029E + B15002_030E,
         uni = B15002_014E + B15002_015E + B15002_016E + B15002_017E + B15002_018E + B15002_031E + B15002_032E + B15002_033E + B15002_034E + B15002_035E, 
         ) %>%
  select(everything(), -matches("B15002")) %>% 
  mutate(tract = as.numeric(tract), .keep = "unused") %>% 
  filter((tract >= 010100 & tract <= 750600) | tract == 760800
         | (tract >= 770500 & tract <= 770700) | tract == 770900 | tract == 810400
         | (tract >= 810400 & tract <= 810600) | tract == 810600 | tract == 811600
         | tract == 823304 | tract == 820902 | tract == 811600 | tract == 840000 
         |  tract == 840801) %>% # Filter only for tracts in Chicago
  filter(tract != 381700) %>% # This tract has no one in it and weird negative income values
  mutate(neighborhood = if_else((tract >= 010100) & (tract <= 010999),
                                "RODGERS PARK",
                                if_else((tract >= 031000) & (tract <= 032199),
                                        "UPTOWN", 
                                        if_else((tract >= 080100) & (tract <= 081999), 
                                                "NEAR NORTH SIDE",
                                                if_else((tract >= 210100) & (tract <= 210999),
                                                        "AVONDALE", 
                                                        if_else((tract >= 340100) & (tract <= 340699), 
                                                                "ARMOUR SQUARE", 
                                                                if_else((tract >= 680100) & (tract <= 681499), 
                                                                        "ENGLEWOOD", 
                                                                        ifelse((tract >= 490100) & (tract <= 491499), 
                                                                                "ROSEWOOD",
                                                                                "REST OF CITY") # Rest of Chicago. 
                                                                        )
                                                                )
                                                        )
                                                )
                                        )
                                )
         ) 

chicago_2010
  
```

```{r Reviewing data}

mm_inc <- chicago_2010 %>% 
  filter(neighborhood != "REST OF CITY") %>%
  group_by(neighborhood) %>%
  select(neighborhood, median_income) %>% 
  summarise(mean_median_income = mean(median_income)) %>% 
  select(mean_median_income)
  
city_inc <- chicago_2010 %>% 
  select(median_income) %>% 
  summarise(mean_median_income = mean(median_income))

cta_inc <- chicago_2010 %>% 
  filter(neighborhood != "REST OF CITY") %>%
  select(median_income) %>% 
  summarise(mean_median_income = mean(median_income))


city_per <- chicago_2010 %>% 
  select(everything(), -tract, -median_income) %>% 
  summarise(across(where(is.numeric), sum)) %>% 
  transmute(native_gd_per = (native_gd_eng / lang_total) * 100, 
         bd_eng_per = (bd_eng / lang_total) * 100,
         not_eng_per = (not_eng / lang_total) * 100,
         primary_sp = (sp_total / lang_total) * 100,
         no_hs_per = (no_hs / edu_total) * 100,
         hs_per = (hs / edu_total) * 100,
         uni_per = (uni / edu_total) * 100, 
         nh_white_per = (nh_white / re_total) * 100,
         h_white_per = (h_white / re_total) * 100, # Need to make note that only NH White and H White are separated, all others are combined
         black_per = ((nh_black + h_black) / re_total) * 100,
         aapi_per = ((nh_asian + h_asian + nh_pi + h_pi) / re_total) * 100, # Also note combo of Asian and Pacific Islander (AAPI)
         othermulti_per = (((nh_other + h_other + nh_multi + h_multi) / re_total) * 100)  # Make note of combo of other race and multi racial
  ) 

city_wide <- cbind("CITY WIDE", city_per, city_inc) %>% 
  rename(neighborhood = `"CITY WIDE"`)

cta_per <- chicago_2010 %>% 
  filter(neighborhood != "REST OF CITY") %>%
  select(everything(), -tract, -median_income) %>% 
  summarise(across(where(is.numeric), sum)) %>% 
  transmute(native_gd_per = (native_gd_eng / lang_total) * 100, 
         bd_eng_per = (bd_eng / lang_total) * 100,
         not_eng_per = (not_eng / lang_total) * 100,
         primary_sp = (sp_total / lang_total) * 100,
         no_hs_per = (no_hs / edu_total) * 100,
         hs_per = (hs / edu_total) * 100,
         uni_per = (uni / edu_total) * 100, 
         nh_white_per = (nh_white / re_total) * 100,
         h_white_per = (h_white / re_total) * 100, 
         black_per = ((nh_black + h_black) / re_total) * 100,
         aapi_per = ((nh_asian + h_asian + nh_pi + h_pi) / re_total) * 100, 
         othermulti_per = (((nh_other + h_other + nh_multi + h_multi) / re_total) * 100)  
  )

cta_wide <- cbind("AREAS WITH CTA IMPROVEMENT", cta_per, cta_inc) %>% 
  rename(neighborhood = `"AREAS WITH CTA IMPROVEMENT"`)
  

percents <- chicago_2010 %>% 
  select(everything(), -tract, -median_income) %>%
  filter(neighborhood != "REST OF CITY") %>%
  group_by(neighborhood) %>% 
  summarise(across(where(is.numeric), sum)) %>% 
  transmute(neighborhood = neighborhood,
         native_gd_per = (native_gd_eng / lang_total) * 100, 
         bd_eng_per = (bd_eng / lang_total) * 100,
         not_eng_per = (not_eng / lang_total) * 100,
         primary_sp = (sp_total / lang_total) * 100,
         no_hs_per = (no_hs / edu_total) * 100,
         hs_per = (hs / edu_total) * 100,
         uni_per = (uni / edu_total) * 100, 
         nh_white_per = (nh_white / re_total) * 100,
         h_white_per = (h_white / re_total) * 100, # Need to make note that only NH White and H White are separated, all others are combined
         black_per = ((nh_black + h_black) / re_total) * 100,
         aapi_per = ((nh_asian + h_asian + nh_pi + h_pi) / re_total) * 100, # Also note combo of Asian and Pacific Islander (AAPI)
         othermulti_per = (((nh_other + h_other + nh_multi + h_multi) / re_total) * 100)  # Make note of combo of other race and multi racial
  ) %>% 
  cbind(mm_inc) %>%
  rbind(cta_wide, city_wide)


percents$neighborhood <- str_to_title(percents$neighborhood)
```

```{r Lang check}
# English and Spanish are going to be highest but let's see how our neighborhoods 
# do in terms of the other languages from Chicago's top 6. 

lang <- chicago_2010 %>% 
  select(everything(), -tract, -median_income) %>%
  filter(neighborhood != "REST OF CITY") %>%
  group_by(neighborhood) %>% 
  summarise(across(where(is.numeric), sum)) %>%
  select(neighborhood, lang_total:sp_total, plsk_total, chn_total, flp_total, arab_total) %>%
  transmute(neighborhood = neighborhood,
            eng_only = round((eng / lang_total) * 100, 2), 
            primary_sp = round((sp_total / lang_total) * 100, 2), 
            primary_plsk = round((plsk_total / lang_total) * 100, 2), 
            primary_chn = round((chn_total / lang_total) * 100, 2), 
            primary_flp = round((flp_total / lang_total) * 100, 2), 
            primary_arab = round((arab_total / lang_total) * 100, 2)) 

city_lang <- chicago_2010 %>% 
  select(everything(), -tract, -median_income) %>% 
  summarise(across(where(is.numeric), sum)) %>% 
  transmute(eng_only = round((eng / lang_total) * 100, 2), 
            primary_sp = round((sp_total / lang_total) * 100, 2), 
            primary_plsk = round((plsk_total / lang_total) * 100, 2), 
            primary_chn = round((chn_total / lang_total) * 100, 2), 
            primary_flp = round((flp_total / lang_total) * 100, 2), 
            primary_arab = round((arab_total / lang_total) * 100, 2))

city_lang <- cbind("CITY WIDE", city_lang) %>% 
  rename(neighborhood = `"CITY WIDE"`)

dim(lang)
dim(city_lang)

all_lang <- rbind(lang, city_lang)

all_lang

```
Only thing interesting is the 6% Polish speakers in Avondale given it's higher than the city-wide average. 
Everything else is what we would expect (high amount of Chinese spoken in Armour Square 
since Chinatown is there) and Avondale being primarily Spanish speakers while Englewood and Rosewood are
almost exclusively English speakers (likely due to the fact that 98% of the community is African American/Black).
Also Near North Side is predictably higher than city average for English, given that this 
neighborhood is predominately White, upper class households. 

# Data Prep and Cleaning - CTA Data

```{r cta api keys}
#API key ID: 7vwfj55tah2za8t0hmgcwkc2w
#API key secret: 4vxjm7n1v7ddid1vhlx4hvn3v0k9dnagm8hc76xm8m7rsbt7jo

cta <- read.socrata("https://data.cityofchicago.org/resource/5neh-572f.json")
```

We decided to look at ridership for 7 stations that had projects completed between
2009 and 2019. We chose stations in areas all throughout the city. If we look at
a summary of this data we can see that we have information from Jan 2001 to
Nov 30, 2020. This works for us as we wanted to have data for at least a year
after a project was completed but before the COVID pandemic affected ridership.
Our most recent project was completed by Feb 2019 so that would give us a year 
of data before the pandemic was in play in Chicago.

```{r check out the data}
summary(cta)
```

For our data we will focus on Jarvis station for the Red North Station Interim
Improvements project; the Wilson Station Reconstruction; Clark/Division Station
Renovation; Addison as part of Blue Line projects; Cermak-Chinatown Station
Renovation; Garfield Station as part of the Red Line South Station Improvements;
and the 95th Dan Ryan Terminal Reconstruction Project. We filter the data for
the stations of interest and to only include weekday ride counts. This has 
ride data by each weekday for every station. On the rail system, a customer is 
counted as an "entry" each time they passes through a turnstile to enter 
a station.  Customers are not counted as "entries" when they make a 
cross-platform transfer from one rail line to another, since they don't pass 
through a turnstile. Where the number given for rail is in "boardings" what is
presented is a statistically valid estimate of the actual number of boardings 
onto the rail system.

```{r filter for our stations and by weekday rides}
cta1 <- as_tibble(
  cta %>%
  group_by(station_id) %>%
  filter(station_id %in% c("41190", "40540", "40630", "41240",
                            "41000", "41170", "40450"),
         daytype == "W") %>% #W is the weekday ridership information
  mutate(date = as.Date(date),
         rides = as.numeric(rides))
)
cta1
```

The dates are presented in year-month-day format in one column which is great for when we look at
ranges of ridership. But we want to report station averages by month so we
separate the date into new columns in order to filter.

```{r filtering for the data I want and new date columns}
cta2 <- 
  cta1 %>%
  group_by(stationname, date, rides) %>%
  filter(date >= as.Date("2007-10-01") & date <= as.Date("2020-01-31")) %>%
  mutate(month = format(date, "%m"), year = format(date, "%Y"))
cta2

```

The specific month for the beginning of the Addison project was unavailable, all sources 
we found indicated that construction "began in Fall 2015," 
so we chose to look at ridership between Oct 2014- Oct 2015.

```{r ridership averages by station}
Cer_Chi <- 
  cta2 %>%
  filter(stationname == "Cermak-Chinatown") %>%
  group_by(month) %>%
  summarise(Cer_Chi_bef = mean(rides[date > as.Date("2008-10-31") & date < as.Date("2009-11-01")]),
            Cer_Chi_aft = mean(rides[date > as.Date("2011-03-31") & date < as.Date("2012-04-01")])) %>% 
  mutate(diff_mean = Cer_Chi_aft - Cer_Chi_bef,
         perc_mean = ((Cer_Chi_aft - Cer_Chi_bef)/ Cer_Chi_bef)*100)
Cer_Chi

Cer_Chi2 <- 
  cta2 %>%
  filter(stationname == "Cermak-Chinatown") %>%
  group_by(month) %>%
  summarise(Cer_Chi_bef = mean(rides[date > as.Date("2008-01-31") & date < as.Date("2009-02-01")]),
            Cer_Chi_aft = mean(rides[date > as.Date("2011-04-30") & date < as.Date("2012-05-01")])) %>% 
  mutate(diff_mean = Cer_Chi_aft - Cer_Chi_bef,
         perc_mean = ((Cer_Chi_aft - Cer_Chi_bef)/ Cer_Chi_bef)*100)
Cer_Chi2

Clark_Div <- 
  cta2 %>%
  filter(stationname == "Clark/Division") %>%
  group_by(month) %>%
  summarise(Clark_Div_bef = mean(rides[date > as.Date("2011-09-01") & date < as.Date("2012-09-01")]),
            Clark_Div_aft = mean(rides[date > as.Date("2015-09-30") & date < as.Date("2016-10-01")])) %>% 
  mutate(diff_mean = Clark_Div_aft - Clark_Div_bef,
         perc_mean = ((Clark_Div_aft - Clark_Div_bef)/ Clark_Div_bef)*100)
Clark_Div

Jarvis <- 
  cta2 %>%
  filter(stationname == "Jarvis") %>%
  group_by(month) %>%
  summarise(Jarvis_bef = mean(rides[date > as.Date("2011-11-01") & date < as.Date("2012-11-01")]),
            Jarvis_aft = mean(rides[date > as.Date("2012-12-31") & date < as.Date("2014-01-01")])) %>% 
  mutate(diff_mean = Jarvis_aft - Jarvis_bef,
         perc_mean = ((Jarvis_aft - Jarvis_bef)/ Jarvis_bef)*100)
Jarvis

Garfield <- 
  cta2 %>%
  filter(stationname == "Garfield-Dan Ryan") %>%
  group_by(month) %>%
  summarise(Garf_bef = mean(rides[date > as.Date("2012-05-01") & date < as.Date("2013-05-01")]),
            Garf_aft = mean(rides[date > as.Date("2013-10-31") & date < as.Date("2014-11-01")])) %>%
  mutate(diff_mean = Garf_aft - Garf_bef,
         perc_mean = ((Garf_aft - Garf_bef)/ Garf_bef)*100)
Garfield

Wilson <- 
  cta2 %>%
  filter(stationname == "Wilson") %>%
  group_by(month) %>%
  summarise(Wilson_bef = mean(rides[date > as.Date("2013-09-30") & date < as.Date("2014-10-01")]),
            Wilson_aft = mean(rides[date > as.Date("2017-10-03") & date < as.Date("2018-10-04")]))%>%
  mutate(diff_mean = Wilson_aft - Wilson_bef,
         perc_mean = ((Wilson_aft - Wilson_bef)/ Wilson_bef)*100)
Wilson

Addison <- 
  cta2 %>%
  filter(stationname == "Addison-O'Hare") %>%
  group_by(month) %>%
  summarise(Addison_bef = mean(rides[date > as.Date("2014-09-30") & date < as.Date("2015-10-01")]),
            Addison_aft = mean(rides[date > as.Date("2016-11-30") & date < as.Date("2017-12-01")])) %>%
  mutate(diff_mean = Addison_aft - Addison_bef,
         perc_mean = ((Addison_aft - Addison_bef)/ Addison_bef)*100)
Addison

DanRyan <- 
  cta2 %>%
  filter(stationname == "95th/Dan Ryan") %>%
  group_by(month) %>%
  summarise(Dan_bef = mean(rides[date > as.Date("2016-02-29") & date < as.Date("2017-03-01")]),
            Dan_aft = mean(rides[date > as.Date("2019-01-31") & date < as.Date("2020-02-01")])) %>%
  mutate(diff_mean = Dan_aft - Dan_bef,
         perc_mean = ((Dan_aft - Dan_bef)/ Dan_bef)*100)
DanRyan
```

When using cbind it will include the month rows for each data set so we will need to join the data
sets using a join function so they are joined by the month column.

```{r cbind}
cta3 <- 
  cbind(Cer_Chi, Clark_Div, Jarvis, Garfield, Wilson, Addison, DanRyan)

cta3 %>%
  kable()
```

We were unable to join all of the data together in one pipe so we added one at a time.
```{r joining data sets}
join <- 
  left_join(Cer_Chi, Clark_Div, by = "month") #some join function would not run without indicating "by"
join

join1 <- 
  left_join(join, Jarvis)
join1

join2 <- 
  left_join(join1, Garfield, by = "month")
join2

join3 <- 
  left_join(join2, Wilson)
join3

join4 <- 
  left_join(join3, Addison, by = "month")
join4

CTA_data <- 
  left_join(join4, DanRyan)
CTA_data
```

We made a table to inspect the station-level data and use as a reference point for our ridership changes.
For brevity sake and ease of interpretation for our readers we found the visualization
of this information in graph form to be more appropriate.
```{r table the station data}
CTA_data %>%
  kable(col.names = c("Month", "Before", "After", "Diff Mean", "Perc Mean", "Before", "After", "Diff Mean", "Perc Mean", "Before", "After", 
                      "Diff Mean", "Perc Mean", 
                     "Before", "After", "Diff Mean", "Perc Mean", "Before", "After", "Diff Mean", "Perc Mean", "Before",  "After",
                     "Diff Mean", "Perc Mean", "Before", "After", "Diff Mean", "Perc Mean"),
        align = c("ccccccccccccccccccccccccccccc"),
        digits = c(0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2),
        caption = "Average Daily Ridership for a Given Month Before and After CTA Project Completion") %>%
  
  kable_classic(font_size = 16,
                 html_font = "Times New Roman",
                 full_width = F) %>%
  add_header_above(c("", "Cer-Chinatown" = 4, "Clark/Division" = 4, "Jarvis" = 4,
                     "Garfield" = 4, "Wilson" = 4, "Addison" = 4, "95th/Dan Ryan" = 4))
```


We filtered the entire data set to only include the weekday data and to include
additional date columns for ease of filtering later.
```{r system changes}
cta_system <- 
  cta %>%
  filter(daytype == "W") %>%
  mutate(date = as.Date(date),
         rides = as.numeric(rides),
         month = format(date, "%m"), year = format(date, "%Y"), day = format(date, "%d"))
```


```{r}
#cta %>%
  #filter(daytype == "W",
         #date <= as.Date("2013-12-31") & date >= as.Date("2012-12-01")) %>%
  #mutate(rides = as.numeric(rides)) %>% 
  #mutate(month = format(date, "%m"), year = format(date, "%Y"), day = format(date, "%d")) %>%
  #group_by(month, day) %>%
  #summarise(monthday_tot = sum(rides)) %>% 
  #group_by(month) %>% 
  #summarise(mean = mean(monthday_tot))

```


We looked at the system-wide changes over the same period of each project to understand
whether any changes in ridership were a result of investment or were following city-wide
trends in ridership.
```{r system wide}
System_Cermak <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Cermak = sum(rides[date > as.Date("2008-10-31") & date < as.Date("2009-11-01")]),
            Mon_aft_Cermak = sum(rides[date > as.Date("2011-03-31") & date < as.Date("2012-04-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Cermak),
            after_mean = mean(Mon_aft_Cermak)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Cermak

System_Cermak2 <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Cermak = sum(rides[date > as.Date("2008-01-31") & date < as.Date("2009-02-01")]),
            Mon_aft_Cermak = sum(rides[date > as.Date("2011-03-31") & date < as.Date("2012-04-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Cermak),
            after_mean = mean(Mon_aft_Cermak)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Cermak2


System_Clark_Division <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Clark_Division = sum(rides[date > as.Date("2011-08-31") & date < as.Date("2012-09-01")]),
            Mon_aft_Clark_Division = sum(rides[date > as.Date("2015-08-31") & date < as.Date("2016-09-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Clark_Division),
            after_mean = mean(Mon_aft_Clark_Division)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Clark_Division

System_Jarvis <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Jarvis = sum(rides[date > as.Date("2011-10-31") & date < as.Date("2012-11-01")]),
            Mon_aft_Jarvis = sum(rides[date > as.Date("2012-11-30") & date < as.Date("2013-12-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Jarvis),
            after_mean = mean(Mon_aft_Jarvis)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Jarvis

System_Garfield <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Garf = sum(rides[date > as.Date("2012-05-01") & date < as.Date("2013-05-01")]),
            Mon_aft_Garf = sum(rides[date > as.Date("2013-10-31") & date < as.Date("2014-11-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Garf),
            after_mean = mean(Mon_aft_Garf)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Garfield

System_Wilson <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Wilson = sum(rides[date > as.Date("2013-09-30") & date < as.Date("2014-10-01")]),
            Mon_aft_Wilson = sum(rides[date > as.Date("2017-09-30") & date < as.Date("2018-10-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Wilson),
            after_mean = mean(Mon_aft_Wilson)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_Wilson

System_Addison <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Addison = sum(rides[date > as.Date("2014-09-30") & date < as.Date("2015-10-01")]),
            Mon_aft_Addison = sum(rides[date > as.Date("2016-11-30") & date < as.Date("2017-12-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Addison),
            after_mean = mean(Mon_aft_Addison)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)  
System_Addison

System_DanRyan <- 
  cta_system %>%
  group_by(month, day) %>%
  summarise(Mon_bef_Dan = sum(rides[date > as.Date("2016-02-29") & date < as.Date("2017-03-01")]),
            Mon_aft_Dan = sum(rides[date > as.Date("2019-01-31") & date < as.Date("2020-02-01")])) %>%
  group_by(month) %>%
  summarise(before_mean = mean(Mon_bef_Dan),
            after_mean = mean(Mon_aft_Dan)) %>%
  mutate(diff_mean = after_mean - before_mean,
         perc_mean = ((after_mean - before_mean)/ before_mean)*100)
System_DanRyan
```

```{r join system data}
sys_join <- 
rbind(System_Cermak, System_Clark_Division, System_Jarvis, System_Garfield, System_Wilson, System_Addison, System_DanRyan)
sys_join
```

```{r table the thing}
sys_join %>%
  kable() %>%
  kable_classic(font_size = 16,
                 html_font = "Times New Roman",
                 full_width = F) %>%
  pack_rows(index = c("Cermak-Chinatown" = 12, "Clark/Division" = 12, "Jarvis" = 12, 
                      "Garfield" = 12, "Wilson" = 12, "Addison" = 12, "95th/Dan Ryan" = 12))
```

# Results and Discussion

## Demographics Tables

```{r Table of Race Data}

percents  %>%
  select(neighborhood, nh_white_per:othermulti_per) %>%
  kable(col.names = c("Area",
                      "Non-Hisp White", "Hisp White", "Black", "AAPI", "Other/Multiracial"), 
        align = "ccc", 
        caption = "Racial Composition of Neighborhoods where CTA Improvements were Made, and City-Wide Values",
        digits = 2, 
        format.args = list(big.mark = ",")) %>%
  kable_styling(latex_options = c("striped", "scale_down"))

```

```{r Table of Lang Data}

percents  %>%
  select(neighborhood,  native_gd_per:primary_sp) %>%
  kable(col.names = c("Area",
                      "English Native or Very Well", "English Less than Very Well", "Primary not English", "Primary Language Spanish"), 
        align = "ccc", 
        caption = "Language Composition of Neighborhoods where CTA Improvements were Made, and City-Wide Values",
        digits = 2, 
        format.args = list(big.mark = ",")) %>%
  kable_styling(latex_options = c("striped", "scale_down"))

```

```{r Table of Edu Data, include=T}

percents  %>%
  select(neighborhood, no_hs_per:uni_per) %>%
  kable(col.names = c("Area",
                      "Less Than a HS", "HS + Some College", "College Degree"), 
        align = "ccc", 
        caption = "Educational Attainment of Neighborhoods where CTA Improvements were Made, and City-Wide Values",
        digits = 2, 
        format.args = list(big.mark = ",")) %>%
  kable_styling(latex_options = c("striped", "scale_down"))

```


```{r Table of Income, include=T}

percents  %>%
  select(neighborhood, mean_median_income) %>%
  kable(col.names = c("Area",
                      "Mean Median Income*"), 
        align = "ccc", 
        caption = "Demographics of Neighborhoods where CTA Improvements were Made, and City-Wide Values",
        digits = 2, 
        format.args = list(big.mark = ",")) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  add_footnote("Value in Real 2010 USD; Values were calculated by taking the median income of each census tract and then taking the average among tracts in a given neighborhood or across all tracts")



```

City of Chicago's population in 2010 was 2.6 million, and this estimates
2.4 million so we are fairly close, a tract or two along the edges may have been
excluded, but the bulk of the city's population is here in the data set.

## Line Plots of Ridership  

Now that we have the data, we will begin with some basic plots of the percent 
difference in means to see overall ridership changes. 

```{r themes} 

red_line <- theme_minimal() + 
  theme(plot.title = element_text(color = "#c60c30", size = 16, face = "bold"), 
        plot.subtitle = element_text(face = "bold.italic", size = 8), 
        plot.caption = element_text(face = "italic", hjust = 0.5), 
        legend.position = "bottom", legend.box = "vertical") 

```

```{r, include=T}
# First, Cermak-Chinatown

ggplot(Cer_Chi, aes(x = month, y = perc_mean)) +
  geom_point(color = "Red") +
  geom_line(group = 1, color = "Red") +
  scale_y_continuous(limits = c(0, 30)) + 
  geom_hline(yintercept = 0)
```
Cermak-Chinatown station is located in Chicago's Armour Square, which is situated just to the Southwest of 
downtown. The presence of Chinatown in Armour Square means the area is predominantly of Asian 
descent.

Here when looking at the period before and after reconstruction, 
we can see that there was a notable increase in ridership after the project was
completed. But how did the system compare for the same time-period? 

```{r Cermak vs System, include=T}
plot_4 <- ggplot() +
  geom_hline(yintercept = mean(Cer_Chi$perc_mean), color = "#c60c30", alpha = 0.5) + # Include average lines to help see average despite variation 
  geom_hline(yintercept = mean(System_Cermak$perc_mean), color = "Black", alpha = 0.5) +
  geom_line(data = Cer_Chi, aes(x = month, y = perc_mean, group = 1), 
            color = "#c60c30") +
  geom_point(data = Cer_Chi, aes(x = month, y = perc_mean, group = 1, color = "#c60c30")) +
  geom_line(data = System_Cermak, aes(x = month, y = perc_mean), 
            color = "Black", group = 2) +
  geom_point(data = System_Cermak, aes(x = month, y = perc_mean, group = 2, color = "Black")) + 
  scale_y_continuous(limits = c(0, 30)) +
  labs(title = "Change in Ridership at Cermak-Chinatown vs. System Wide",
       subtitle = "Difference in the average number of riders for the 12 month period before November 2009 and after April 2011",
       caption = "Source: Chicago Transit Authority Daily Ridership Dataset via Chicago Data Portal") +
  xlab("Number of Months Before/After Project") + 
  ylab("% Change in Mean Ridership") +
  scale_color_manual(name = "Station", 
                    labels = c("Cermak-Chinatown (Red Line)", "System-wide"), 
                    values = c("#c60c30", "Black")) +
  red_line

plot_4

#  geom_hline(yintercept = 0, color = "Gray", linetype = "dashed") +

```
This is interesting, during the same time, the overall system saw general growth, but 
at a lower rate, which means some of this increase is accounted for by overall system
usage growth, but there is still a sizable difference in the two, suggesting that 
the station improvement did increase ridership at the station. 

While this seemingly contradicts the hypothesis that improvements to historically underserved 
communities would see a weaker impact on ridership, there is some important historical 
context to be considered with this case. First, while the neighborhood surrounding 
the Cermak-Chinatown stop is predominantly Asian and Pacific Islander (47% compared to the city's 
total of 5%), and the most commonly spoken language being Chinese (43% compared to the city's total 
of 1%), the presence of Chinatown in this area does make it a significant tourist destination 
for both out of town and local visitors. Another important factor to consider is the 
context that brought about the station project. 

The Cermak-Chinatown station is [located](https://goo.gl/maps/jQ6pe7nEz2xcw8F79) just North
of a major off ramp to the Stevenson (I-55) and Dan Ryan (I-90/I-94) Expressways where 
traffic must turn either East or West onto Cermak Road, with the main station house 
of the station located directly across Cermak road. A year prior to the project's start
[in April of 2008](https://www.chicagotribune.com/news/ct-xpm-2008-04-26-0804251037-story.html),
a  semi-trailer truck came speeding off the exit ramp and collided into the station 
house, killing two people and injuring 21. The accident left the public shaken, with 
many faulting a lack of pedestrian shielding (i.e., bollards) as a cause for the deaths. 

If we shift the 12 month period from November 2008 to November 2009 to include the months leading up to
and after the accident (i.e., February 2008 to February 2009): 

```{r 2008 down trend, include=T}

plot_4.1 <- ggplot() +
  geom_line(data = Cer_Chi2, aes(x = month, y = Cer_Chi_bef, group = 1), 
            color = "#c60c30") +
  geom_point(data = Cer_Chi2, aes(x = month, y = Cer_Chi_bef, group = 1), color = "#c60c30") +
  geom_hline(yintercept = mean(Cer_Chi2$Cer_Chi_bef), color = "#c60c30") + 
  xlab("Average Number of Riders per Month") +
  labs(title = "Cermak-Chinatown") +
  red_line

plot_4.2 <- ggplot() +   
  geom_line(data = System_Cermak2, aes(x = month, y = before_mean), 
            color = "Black", group = 1) +
  geom_point(data = System_Cermak2, aes(x = month, y = before_mean, group = 1), color = "Black") +
  geom_hline(yintercept = mean(System_Cermak2$before_mean), color = "Black") + 
  xlab("Average Number of Riders per Month") +
  labs(title = "System-Wide") +
  red_line + 
  theme(plot.title = element_text(color = "Black", size = 16, face = "bold"))

plot_4.3 <- ggarrange(plot_4.1, plot_4.2, nrow = 1, ncol = 2)

plot_4.3

```
It would seem that ridership actually increased, but let's look at the percent differences 
to see how this compares. 
```{r }
ggplot() +
  geom_line(data = Cer_Chi2, aes(x = month, y = perc_mean, group = 1), 
            color = "#c60c30") +
  geom_point(data = Cer_Chi2, aes(x = month, y = perc_mean, group = 1), color = "#c60c30") +
  geom_line(data = System_Cermak2, aes(x = month, y = perc_mean), 
            color = "Black", group = 1) +
  geom_point(data = System_Cermak2, aes(x = month, y = perc_mean, group = 1), color = "Black") + 
  geom_hline(yintercept = mean(Cer_Chi2$perc_mean), color = "#c60c30") + # Include average lines to help see average despite variation 
  geom_hline(yintercept = mean(System_Cermak2$perc_mean), color = "Black") +
  labs(title = "Cermak-Chinatown vs. System Wide Feb. 2008 to Feb. 2009",
       caption = "Source: Chicago Transit Authority Daily Ridership Dataset via Chicago Data Portal") +
  xlab("Number of Months Before/After Project") + 
  ylab("% Change in Mean Ridership") +
  scale_color_manual(name = "Station", 
                    labels = c("Cermak-Chinatown (Red Line)", "System-wide"), 
                    values = c("#c60c30", "Black")) +
  red_line

```
This shows us a very different story. Here we can see that while ridership growth
was positive, beginning in April of 2008 (month 3) that positive growth declined both 
for Cermak-Chinatown and system wide, but where the system saw a resurgence in the positive 
growth, Cermak-Chinatown stayed lower than the system-wide growth for the rest of the year, 
with ridership only spiking to a seasonal high in January of 2009. Given the timing of the 
decline in positive growth, it is likely that the accident played a role in keeping ridership 
lower in the months preceding the station project, which could suggest that the observed positive 
growth that was previously observed could in part be inflated by the timing of the accident. 

```{r Cermak vs System test, include = TRUE}

# Was curious to see what the plot would look like if we plotted actual values before and after 
# rather than the % difference. 


a <- ggplot() +
  geom_line(data = Cer_Chi, aes(x = month, y = Cer_Chi_bef, group = 1), 
            color = "#c60c30") +
  geom_point(data = Cer_Chi, aes(x = month, y = Cer_Chi_bef, group = 1, color = "#c60c30")) + 
  geom_line(data = Cer_Chi, aes(x = month, y = Cer_Chi_aft, group = 1), 
            color = "#ff0f3d") +
  geom_point(data = Cer_Chi, aes(x = month, y = Cer_Chi_aft, group = 1, color = "#ff0f3d"))  + 
  scale_color_manual(name = "Time", 
                    labels = c("Before)", "After"), 
                    values = c("#c60c30", "#ff0f3d")) +
  labs(title = "Cermak-Chinatown") +
  xlab("Number of Months Before/After Project") + 
  ylab("Mean # of Riders") +
  red_line
  
b <- ggplot() + 
  geom_line(data = System_Cermak, aes(x = month, y = before_mean, group = 1), color = "Black") +
  geom_point(data = System_Cermak, aes(x = month, y = before_mean, group = 1, color = "Black")) +
  geom_line(data = System_Cermak, aes(x = month, y = after_mean), 
            color = "Gray", group = 1) +
  geom_point(data = System_Cermak, aes(x = month, y = after_mean, group = 1, color = "Gray")) +
  scale_color_manual(name = "Time", 
                    labels = c("Before)", "After"), 
                    values = c("Black", "Gray")) + 
  labs(title = "System-Wide") +
  xlab("Number of Months Before/After Project") + 
  ylab("Mean # of Riders") +
  red_line +
  theme(plot.title = element_text(color = "Black", size = 16, face = "bold"))



figure <- ggarrange(a, b, nrow = 1, ncol = 2) + 
    labs(title = "Cermak-Chinatown vs. System Wide Actual Values",
       caption = "Source: Chicago Transit Authority Daily Ridership Dataset via Chicago Data Portal") 

figure

```

One issue here is the drastically different y scales (almost a 100 fold difference), when compared
side by side it makes it seem as though the totals are similar, even though they are drastically different.
What is helpful about displaying the data this way is that it makes deviations more clear. For example
in this graph, the drop in ridership from months 3 to 5 after the project is clearly 
a system wide decline, although with the difference scales it is hard to gauge the difference 
in relative % terms. 

Now to our next project of interest, the 95th/Dan-Ryan Terminal improvement project. 

```{r, include=T}
ggplot(DanRyan, aes(x = month, y = perc_mean)) +
  geom_point(color = "Red") +
  geom_line(group = 1, color = "Red") +
  scale_y_continuous(limits = c(-25, 0)) + 
  geom_hline(yintercept = 0)
```
Now this is interesting, despite the fact that this project vastly improved the terminal at 95th Street, 
ridership actually appears to have significantly **decreased** when compared to ridership
before the project. Let's look into this further. 

```{r DanRyan vs System}
plot_7 <- ggplot() +
  geom_line(data = DanRyan, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_point(data = DanRyan, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_DanRyan, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = System_DanRyan, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  scale_y_continuous(limits = c(-25,10)) +
  geom_hline(yintercept = mean(DanRyan$perc_mean), color = "Red") +
  geom_hline(yintercept = mean(System_DanRyan$perc_mean), color = "Black") +
  labs(title = "Change in Ridership at 95th/Dan Ryan vs. System Wide",
       subtitle = "Difference in the average number of riders for the 12 month period before March 2017 and after January 2019",
       caption = "Source: Chicago Transit Authority Daily Ridership Dataset via Chicago Data Portal") +
  xlab("Number of Months Before/After Project") + 
  ylab("% Change in Mean Ridership") +
  scale_color_manual(name = "Station", 
                    labels = c("Cermak-Chinatown (Red Line)", "System-wide"), 
                    values = c("#c60c30", "Black")) +
  red_line


plot_7
```
It seems that over the same time period, the system also experienced a slight decline 
in ridership of around -5%, while the 95th street terminal saw a drop in ridership of 
nearly **17%** Let's compare the before and after ridership numbers in total terms.

```{r DanRyan B&A Total rides}
plot_7.1 <- ggplot() +
  geom_line(data = DanRyan, aes(x = month, y = Dan_bef), 
            group = 1, color = "Red") +
  geom_point(data = DanRyan, aes(x = month, y = Dan_bef), 
            group = 1, color = "Red") +
  geom_line(data = DanRyan, aes(x = month, y = Dan_aft), 
            group = 1, color = "Black") +
  geom_point(data = DanRyan, aes(x = month, y = Dan_aft), 
            group = 1, color = "Black")

plot_7.1
```
Now let's do the same for the entire system... 

```{r System B&A Total rides}
plot_7.2 <- ggplot() +
  geom_line(data = System_DanRyan, aes(x = month, y = before_mean), 
            group = 1, color = "Red") +
  geom_point(data = System_DanRyan, aes(x = month, y = before_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_DanRyan, aes(x = month, y = after_mean), 
            group = 1, color = "Black") +
  geom_point(data = System_DanRyan, aes(x = month, y = after_mean), 
            group = 1, color = "Black")

plot_7.2
```
So for the same period the system appears to have experienced a drop in ridership, which 
may account for some of the decline seen at 95th, but not for all of it. One possible
explanation for the decline in ridership despite the notable improvements to the station 
could be that riders, who were already dissatisfied with the poor service provided
by the station shifted to other forms of transit in response to the construction 
work in connection with the improvement project, which caused significant changes 
to service to accommodate the construction without having to close the station. Once 
the construction was completed these riders that had shifted modes simply continued 
to use these alternative modes of transit, possibly because of skepticism that
the station improvements would provide the service and customer experience 
improvements that they promised to deliver. 

That being said, it is difficult to gauge how much of this decrease is simply the result
of riders slowly returning to this mode of transit, as the improvement project lasted nearly 2
years beginning in March of 2017 and ending in January of 2019. Normally, we could simply refer to additional 
data given that ridership data is available through 2021, however, the issue is that 
within one year of this project being completed, ridership saw an **extreme** decline 
as a result of the COVID-19 pandemic.

While uncertainty remains as to *why* ridership was lower after the completion of the 
95th terminal improvement project, it is clear that ridership did in fact decline over 
the course of the project and still has not recovered to pre-project levels. This is particularly 
interesting given that it is a major terminus for the CTA, with significant interconnecting bus
service at the terminal. 

Two other interesting cases are that of Jarvis and Garfield, two smaller stations that 
essentially saw no change in ridership from before and after their respective improvement 
projects. Both stations are located along the Red line which follows a primarily 
North-South route through most of the city. Jarvis is located in the Far North side neighborhood 
of Rodgers Park. On the opposite side of the city is Garfield, located in the South side
neighborhood of Englewood. 

```{r Jarvis vs System}
plot_1 <- ggplot() +
  geom_line(data = Jarvis, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_point(data = Jarvis, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_Jarvis, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = System_Jarvis, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  scale_y_continuous(limits = c(-20,15)) +
  geom_hline(yintercept = mean(Jarvis$perc_mean), color = "Red") +
  geom_hline(yintercept = mean(System_Jarvis$perc_mean), color = "Black")

plot_1
```

```{r Garfield vs System}
plot_6 <- ggplot() +
  geom_line(data = Garfield, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_Garfield, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = Garfield, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_point(data = System_Garfield, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_hline(yintercept = mean(Garfield$perc_mean), color = "Red") +
  geom_hline(yintercept = mean(Garfield$perc_mean), color = "Black") 

plot_6
```


```{r Clark/Div vs System}
plot_3 <- ggplot() +
  geom_line(data = Clark_Div, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_point(data = Clark_Div, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_Clark_Division, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = System_Clark_Division, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_hline(yintercept = mean(Clark_Div$perc_mean), color = "Red") +
  geom_hline(yintercept = mean(System_Clark_Division$perc_mean), color = "Black") 

plot_3
```


```{r Addison vs System}
plot_5 <- ggplot() +
  geom_line(data = Addison, aes(x = month, y = perc_mean), 
            group = 1, color = "Blue") +
  geom_point(data = Addison, aes(x = month, y = perc_mean), 
            group = 1, color = "Blue") +
  geom_line(data = System_Addison, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = System_Addison, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_hline(yintercept = mean(Addison$perc_mean), color = "Blue") +
  geom_hline(yintercept = mean(System_Addison$perc_mean), color = "Black") +
  scale_y_continuous(limits = c(-20,15))

plot_5
```



```{r Wilson vs System}
plot_2 <- ggplot() +
  geom_line(data = Wilson, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_line(data = System_Wilson, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  geom_point(data = Wilson, aes(x = month, y = perc_mean), 
            group = 1, color = "Red") +
  geom_point(data = System_Wilson, aes(x = month, y = perc_mean), 
            group = 1, color = "Black") +
  scale_y_continuous() +
  geom_hline(yintercept = mean(Wilson$perc_mean), color = "Red") +
  geom_hline(yintercept = mean(System_Wilson$perc_mean), color = "Black") 

plot_2
```



```{r Charts, fig.width = 30, include = F}

figures <- ggarrange(plot_1, plot_2, plot_3, plot_4, plot_5, plot_6, plot_7, ncol = 7, nrow = 1)

figures

# Not helpful, too much info and too messy. 

```


# Conclusions